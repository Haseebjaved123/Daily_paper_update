name: Advanced Paper Update (Every 2 Hours) - Multi-Source Intelligence

on:
  schedule:
    # Run every 2 hours for maximum freshness
    - cron: '0 */2 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  issues: write

jobs:
  fetch-and-process-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run advanced paper fetcher (Multi-Source)
      run: |
        echo "🚀 Starting Advanced Paper Update System..."
        echo "📊 Sources: arXiv, Papers with Code, Reddit r/MachineLearning, Google Scholar"
        python daily_paper_fetcher.py
        echo "✅ Multi-source intelligence system completed!"
    
    - name: Upload run logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: paper-update-logs-${{ github.run_number }}
        path: |
          **/*.log
          2025/**/*
          *.md
        retention-days: 7
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "📄 New papers found and processed!"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ℹ️ No new papers found this run"
        fi
    
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Advanced Paper Bot"
        git add .
        git commit -m "🤖 Advanced Paper Update: $(date +'%Y-%m-%d %H:%M UTC') - Multi-Source Intelligence"
        git push
        echo "✅ Changes committed and pushed successfully!"
    
    - name: Create issue if no papers found (with enhanced info)
      if: steps.verify-changed-files.outputs.changed == 'false'
      uses: actions/github-script@v6
      with:
        script: |
          const today = new Date().toISOString().split('T')[0];
          const time = new Date().toISOString().split('T')[1].split('.')[0];
          const title = `No papers found for ${today} at ${time} UTC`;
          const body = `## 🔍 Multi-Source Paper Update Report
          
          **Date**: ${today} at ${time} UTC
          
          **Sources Checked**:
          - ✅ arXiv (Academic papers)
          - ✅ Papers with Code (Trending implementations)  
          - ✅ Reddit r/MachineLearning (Community discussions)
          - ✅ Google Scholar (Academic trending)
          - ⚠️ NewsAPI (Requires API key)
          
          **Status**: No suitable papers found from any source
          
          **Possible Reasons**:
          1. All sources are temporarily unavailable
          2. No new papers published in the last 2 hours
          3. Papers don't meet quality criteria
          4. Network connectivity issues
          
          **Next Steps**: The system will automatically retry in 2 hours.`;
          
          // Check if issue already exists for today
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'daily-update'
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes(today) && issue.title.includes('No papers found')
          );
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['daily-update', 'automation', 'multi-source']
            });
            console.log('📝 Issue created for no papers found');
          } else {
            console.log('ℹ️ Issue already exists for today');
          }
  
  validate-content:
    runs-on: ubuntu-latest
    needs: fetch-and-process-news
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate generated content
      run: |
        echo "🔍 Validating generated paper content..."
        python test_system.py
        echo "✅ Content validation completed!"
    
    - name: Check repository structure
      run: |
        echo "📁 Repository structure:"
        find 2025 -name "*.md" -type f | head -10
        echo "📊 Total papers generated:"
        find 2025 -name "*.md" -type f | wc -l
